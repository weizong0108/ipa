name: iOS Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number'
        required: true
        default: '1'

jobs:
  build:
    name: Build iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - name: Install Flutter dependencies
        run: |
          flutter pub get
          
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
          
      - name: Install CocoaPods
        run: |
          gem install cocoapods
          pod setup
        
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install

      - name: Setup Keychain
        env:
          KEYCHAIN_NAME: build.keychain
        run: |
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | xargs)
          security default-keychain -s "$KEYCHAIN_NAME"
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" "$KEYCHAIN_NAME"
          security set-keychain-settings -t 3600 -l "$KEYCHAIN_NAME"
          
      - name: Import Certificate
        env:
          KEYCHAIN_NAME: build.keychain
          CERTIFICATE_PATH: certificate.p12
        run: |
          echo "${{ secrets.IOS_P12_CERTIFICATE }}" | base64 --decode > "$CERTIFICATE_PATH"
          security import "$CERTIFICATE_PATH" -k "$KEYCHAIN_NAME" -P "${{ secrets.IOS_P12_PASSWORD }}" -A
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" "$KEYCHAIN_NAME"
          rm "$CERTIFICATE_PATH"
          
      - name: Setup Provisioning Profile
        env:
          PROFILE_PATH: profile.mobileprovision
        run: |
          echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > "$PROFILE_PATH"
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PROFILE_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/
          rm "$PROFILE_PATH"
          
      - name: Update Build Number
        run: |
          cd ios
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ github.event.inputs.build_number || '1' }}" Runner/Info.plist

      - name: Build IPA
        env:
          DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
        run: |
          flutter build ios --release --no-codesign
          cd ios
          xcodebuild clean archive \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath build/Runner.xcarchive \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="GAC Music App Distribution" \
            DEVELOPMENT_TEAM="${{ secrets.TEAM_ID }}" \
            CODE_SIGN_IDENTITY="Apple Distribution"
            
          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/ios/ipa \
            -allowProvisioningUpdates
            
      - name: Upload IPA
        uses: actions/upload-artifact@v3
        with:
          name: app-release
          path: ios/build/ios/ipa/*.ipa
          retention-days: 5